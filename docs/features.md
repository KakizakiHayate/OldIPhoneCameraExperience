# 機能一覧（Phase 1: MVP）

本ドキュメントはMVP（Phase 1）で実装する機能の一覧と詳細仕様を定義する。
MVP要件書（[docs/mvp-requirements.md](mvp-requirements.md)）に基づく。

---

## 要件確認で決定した事項

| # | 項目 | 決定内容 |
|---|------|---------|
| 1 | フラッシュ状態数 | 2状態（オン/オフ）。要件書内の「自動」は含めない |
| 2 | 手ブレシミュレーションの適用タイミング | 撮影時のみ（プレビューには適用しない） |
| 3 | ジャイロスコープによるブレ方向決定 | MVP Phase 1に含める（CoreMotion連携） |
| 4 | パーミッション拒否時の動作 | シンプルなアラート表示 + 設定アプリへの誘導 |
| 5 | 画面の向き | 縦持ち（ポートレート）固定 |
| 6 | シャッター音 | 常に鳴らす（消音モード含む。日本市場向け） |
| 7 | システムステータスバー | 非表示（レトロUI全画面表示） |

---

## 機能カテゴリ一覧

| カテゴリ | 機能数 | 概要 |
|---------|--------|------|
| [F1. カメラ基盤](#f1-カメラ基盤) | 4 | AVFoundationによるカメラ制御・撮影・保存 |
| [F2. iPhone 4再現フィルター](#f2-iphone-4再現フィルター) | 3 | 暖色系色味・画角クロップ・手ブレシミュレーション |
| [F3. スキューモーフィズムUI](#f3-スキューモーフィズムui) | 5 | iOS 4〜6風のカスタムUIコンポーネント |
| [F4. シャッター演出](#f4-シャッター演出) | 3 | 虹彩絞り・シャッター音・白フェード |
| [F5. パーミッション管理](#f5-パーミッション管理) | 1 | カメラ・フォトライブラリのアクセス許可 |

合計: **16機能**

---

## F1. カメラ基盤

カメラの制御・撮影・保存に関する機能。Service層（`CameraService`, `PhotoLibraryService`）で実装する。

### F1.1 リアルタイムカメラプレビュー

| 項目 | 内容 |
|------|------|
| **機能ID** | F1.1 |
| **概要** | カメラの映像をリアルタイムで画面に表示する |
| **詳細** | AVCaptureSessionを使用し、背面カメラの映像をリアルタイムでプレビュー表示する。プレビューにはiPhone 4再現フィルター（F2.1 暖色系色味、F2.2 画角クロップ）がリアルタイムで適用される。アスペクト比は4:3（iPhone 4カメラと同一）。手ブレシミュレーション（F2.3）はプレビューには適用しない。 |
| **受け入れ条件** | - カメラ起動後、プレビューが30fps以上で表示される<br>- アスペクト比4:3でプレビューが表示される<br>- 暖色系フィルター（F2.1）と画角クロップ（F2.2）がリアルタイムで適用された状態で表示される<br>- 手ブレシミュレーション（F2.3）はプレビューに適用されない |
| **技術アプローチ** | AVCaptureSession + AVCaptureVideoDataOutput → CIFilter適用 → Metal/CoreImageでレンダリング |
| **関連ファイル** | `Services/CameraService.swift`, `Views/Components/Camera/CameraPreview.swift` |
| **非機能要件** | プレビューFPS: 30fps以上、起動〜撮影可能: 2秒以内 |

### F1.2 写真撮影・保存

| 項目 | 内容 |
|------|------|
| **機能ID** | F1.2 |
| **概要** | シャッターボタンタップで撮影し、フィルター適用後にカメラロールへ保存する |
| **詳細** | シャッターボタン（F3.3）タップ時に、現在のカメラフレームをキャプチャし、iPhone 4再現フィルター（F2.1〜F2.3すべて）を適用した上でカメラロールに保存する。撮影中は連続撮影を防止する（シャッターボタン無効化）。保存完了後、直近撮影写真サムネイル（F3.5）を更新する。 |
| **受け入れ条件** | - シャッターボタンタップで撮影される<br>- 全フィルター（暖色系色味・画角クロップ・手ブレシミュレーション）が適用された写真がカメラロールに保存される<br>- 出力画像の解像度が2592x1936px（4:3、5MP相当）になる<br>- 撮影〜保存が1秒以内に完了する<br>- 撮影中はシャッターボタンが無効化される<br>- 保存後にサムネイル（F3.5）が更新される |
| **技術アプローチ** | AVCapturePhotoOutput → CIFilter適用 → Photos Framework（PHPhotoLibrary）で保存 |
| **関連ファイル** | `Services/CameraService.swift`, `Services/FilterService.swift`, `Services/PhotoLibraryService.swift` |
| **非機能要件** | 撮影〜保存: 1秒以内 |

### F1.3 フラッシュ切り替え

| 項目 | 内容 |
|------|------|
| **機能ID** | F1.3 |
| **概要** | フラッシュのオン/オフを切り替える |
| **詳細** | トップツールバー（F3.1）左側のフラッシュボタンで、フラッシュのオン/オフを切り替える。**2状態（オン/オフ）のみ**（「自動」は含めない）。iPhone 4準拠のシンプルなフラッシュ。前面カメラ使用時はフラッシュボタンを非表示にする（前面カメラにはフラッシュなし）。 |
| **受け入れ条件** | - フラッシュボタンタップでオン/オフが切り替わる<br>- 現在の状態がUIに反映される（オン時はアイコンがハイライト）<br>- フラッシュオン時に撮影すると、フラッシュが発光する<br>- 前面カメラ時はフラッシュボタンが非表示になる<br>- アプリ起動時のデフォルトはオフ |
| **技術アプローチ** | AVCaptureDevice.torchMode / AVCapturePhotoSettings.flashMode |
| **関連ファイル** | `Services/CameraService.swift`, `ViewModels/CameraViewModel.swift` |

### F1.4 前面/背面カメラ切り替え

| 項目 | 内容 |
|------|------|
| **機能ID** | F1.4 |
| **概要** | 前面カメラと背面カメラを切り替える |
| **詳細** | トップツールバー（F3.1）右側のカメラ切り替えボタンで、前面/背面カメラを切り替える。切り替え時はプレビューが一時停止し、新しいカメラのプレビューが表示される。切り替えアニメーション（フリップ）を付ける。前面カメラに切り替えた場合、フラッシュボタンを非表示にする（F1.3参照）。アプリ起動時のデフォルトは背面カメラ。 |
| **受け入れ条件** | - カメラ切り替えボタンタップで前面/背面が切り替わる<br>- 切り替え後もリアルタイムプレビュー・フィルターが正常に動作する<br>- 切り替え時にフリップアニメーションが表示される<br>- 前面カメラ時はフラッシュボタンが非表示になる<br>- アプリ起動時は背面カメラで起動する |
| **技術アプローチ** | AVCaptureDevice.Position切り替え + AVCaptureSession再構成 |
| **関連ファイル** | `Services/CameraService.swift`, `ViewModels/CameraViewModel.swift` |

---

## F2. iPhone 4再現フィルター

CIFilterを組み合わせてiPhone 4の画質を再現するフィルターチェーン。Service層（`FilterService`）で実装する。
リアルタイムプレビュー（F1.1）と撮影時（F1.2）の両方で使用する（ただしF2.3は撮影時のみ）。

### F2.1 暖色系の色味（最優先）

| 項目 | 内容 |
|------|------|
| **機能ID** | F2.1 |
| **概要** | iPhone 4特有の暖かみのある色味を再現する |
| **詳細** | 赤・オレンジ寄りの暖かいホワイトバランスシフトを適用する。肌色が柔らかく、夕陽や室内灯が優しく染み込むような色調。自動色補正を抑え「その場の光の色」が残る質感。彩度を若干落とし、素朴なくすみ感を付与。ハイライトに微かな黄色〜オレンジのティントを加える。 |
| **適用タイミング** | リアルタイムプレビュー + 撮影時 |
| **受け入れ条件** | - プレビュー・撮影写真に暖色系の色味が適用される<br>- 実際のiPhone 4で撮影した写真と並べて、近い色味になっている<br>- 彩度がやや控えめで、くすみ感がある<br>- ハイライトに黄色〜オレンジのティントがある<br>- 最新iPhoneのクールな色味と明確に異なる |
| **技術アプローチ** | CITemperatureAndTint（暖色シフト）→ CIColorMatrix（彩度調整・ティント）→ ハイライトへのオレンジティント |
| **関連ファイル** | `Services/FilterService.swift` |
| **パラメータ（初期値・チューニング対象）** | - 色温度シフト: +500〜+1500K相当<br>- 彩度: 0.85〜0.95（やや減）<br>- ハイライトティント: 黄〜オレンジ方向に微調整 |

### F2.2 画角クロップ

| 項目 | 内容 |
|------|------|
| **機能ID** | F2.2 |
| **概要** | iPhone 4相当の画角（約32mm相当）にクロップし、出力解像度を5MP相当に制限する |
| **詳細** | 最新iPhoneの広角レンズ（約26mm相当）から、iPhone 4の画角（約32mm相当）にクロップする。これにより背景が圧縮され、被写体が自然に際立つ構図になる。出力解像度はiPhone 4に合わせて2592x1936px（5MP相当）に制限する。クロップは画像中央を基準にする。 |
| **適用タイミング** | リアルタイムプレビュー + 撮影時 |
| **受け入れ条件** | - プレビュー・撮影写真がiPhone 4相当の画角にクロップされる<br>- 出力画像の解像度が2592x1936px（4:3）になる<br>- クロップは画像中央を基準にする<br>- プレビュー時もクロップ後の画角が表示される |
| **技術アプローチ** | CIImage.cropped(to:) で中央クロップ → CILanczosScaleTransform で5MP相当にリサイズ |
| **関連ファイル** | `Services/FilterService.swift` |
| **パラメータ** | - クロップ率: 約81%（26mm→32mm換算）<br>- 出力解像度: 2592x1936px（アスペクト比4:3） |

### F2.3 手ブレシミュレーション

| 項目 | 内容 |
|------|------|
| **機能ID** | F2.3 |
| **概要** | 光学手ブレ補正がなかった時代の自然な微ブレを再現する |
| **詳細** | 撮影時にランダムな微小シフト（数ピクセル）とわずかな回転を適用する。モーションブラーをランダムな角度・強度で軽く適用する。強さは「弱め〜中」の範囲でランダム変動（やりすぎ防止）。**ジャイロスコープ（CoreMotion）のデータを活用して実際の端末の傾きからブレ方向を決定する。** プレビューには適用しない（撮影時のみ）。 |
| **適用タイミング** | 撮影時のみ（プレビューには適用しない） |
| **受け入れ条件** | - 撮影した写真に自然な微ブレが適用される<br>- ブレの方向がジャイロスコープのデータに基づいて決定される<br>- ブレの強度が撮影ごとにランダムに変化する<br>- ブレが過剰でなく、自然な手持ち撮影の揺れに見える<br>- プレビューにはブレが適用されない<br>- 同じシーンを撮影しても毎回微妙に異なるブレになる |
| **技術アプローチ** | CoreMotion（CMMotionManager）でデバイスの傾き取得 → CIAffineTransform（微小シフト+回転）→ CIMotionBlur（ジャイロ方向ベースの角度・ランダム強度） |
| **関連ファイル** | `Services/FilterService.swift` |
| **パラメータ（初期値・チューニング対象）** | - シフト量: 1〜5px（ランダム）<br>- 回転角度: -0.5°〜+0.5°（ランダム）<br>- モーションブラー半径: 1.0〜3.0（ランダム）<br>- モーションブラー角度: ジャイロスコープのデータから算出 |
| **スケジュールリスク時の対応** | 開発が遅延した場合、F2.3全体をPhase 2に回す候補 |

---

## F3. スキューモーフィズムUI

iOS 4〜6時代のカメラアプリUIを忠実に再現するカスタムUIコンポーネント。
すべてSwiftUIのカスタム描画で実装する（標準UIコンポーネントは使用しない）。
画面の向きは**縦持ち（ポートレート）固定**。システムステータスバーは**非表示**。

### F3.1 トップツールバー

| 項目 | 内容 |
|------|------|
| **機能ID** | F3.1 |
| **概要** | iOS 6風の上部ツールバー |
| **詳細** | 黒〜グレーのグラデーション背景を持つiOS 6風ツールバー。左側にフラッシュ切り替えボタン（F1.3）、右側にカメラ切り替えボタン（F1.4）を配置する。ボタンはベベル・シャドウ付きの立体的なデザイン。システムステータスバーは非表示にし、このツールバーが画面最上部に来る。 |
| **受け入れ条件** | - 黒〜グレーのグラデーション背景が表示される<br>- 左側にフラッシュボタンが配置される<br>- 右側にカメラ切り替えボタンが配置される<br>- ボタンに立体的な質感（ベベル・シャドウ）がある<br>- システムステータスバーが非表示になっている<br>- iOS 6時代のツールバーの雰囲気を再現している |
| **技術アプローチ** | SwiftUI: LinearGradient背景 + カスタムButtonスタイル（シャドウ・ベベル） |
| **関連ファイル** | `Views/Components/Skeuomorphic/TopToolbar.swift` |

### F3.2 ファインダー（カメラプレビューエリア）

| 項目 | 内容 |
|------|------|
| **機能ID** | F3.2 |
| **概要** | 4:3アスペクト比のカメラプレビュー表示エリア |
| **詳細** | カメラのリアルタイムプレビュー（F1.1）を表示するエリア。アスペクト比4:3で、iPhone 4のカメラと同じ比率。フィルター適用済みの映像が表示される。上下ツールバーの間に配置される。 |
| **受け入れ条件** | - 4:3アスペクト比でプレビューが表示される<br>- フィルター適用済みの映像がリアルタイムで表示される<br>- 画面の上下ツールバーの間に適切に配置される |
| **技術アプローチ** | UIViewRepresentable + AVCaptureVideoPreviewLayer or Metal rendering |
| **関連ファイル** | `Views/Components/Camera/CameraPreview.swift` |

### F3.3 シャッターボタン

| 項目 | 内容 |
|------|------|
| **機能ID** | F3.3 |
| **概要** | iOS 4〜6風の金属質感シャッターボタン |
| **詳細** | ボトムツールバー（F3.4）中央に配置される、金属質感の丸いシャッターボタン。内側にカメラアイコンを配置。タップ時に押し込みアニメーション（スケール縮小+シャドウ変化）を付ける。撮影中（F1.2）は無効化状態になる。 |
| **受け入れ条件** | - 金属質感（グラデーション・光沢・シャドウ）が表現されている<br>- 内側にカメラアイコンがある<br>- タップ時に押し込みアニメーションがある<br>- 撮影中はボタンが無効化される<br>- iOS 4〜6時代のシャッターボタンの雰囲気を再現している |
| **技術アプローチ** | SwiftUI: Circle + RadialGradient + シャドウ + scaleEffect アニメーション |
| **関連ファイル** | `Views/Components/Skeuomorphic/ShutterButton.swift` |

### F3.4 ボトムツールバー

| 項目 | 内容 |
|------|------|
| **機能ID** | F3.4 |
| **概要** | 黒背景・金属質感の下部ツールバー |
| **詳細** | 黒背景に金属質感のテクスチャを持つ下部ツールバー。中央にシャッターボタン（F3.3）、左側に直近撮影写真サムネイル（F3.5）を配置する。 |
| **受け入れ条件** | - 黒背景に金属質感のテクスチャが表示される<br>- 中央にシャッターボタンが配置される<br>- 左側にサムネイルが配置される<br>- iOS 4〜6時代の下部ツールバーの雰囲気を再現している |
| **技術アプローチ** | SwiftUI: LinearGradient背景 + ノイズテクスチャオーバーレイ |
| **関連ファイル** | `Views/Components/Skeuomorphic/BottomToolbar.swift` |

### F3.5 直近撮影写真サムネイル

| 項目 | 内容 |
|------|------|
| **機能ID** | F3.5 |
| **概要** | 直近に撮影した写真のサムネイルを表示し、タップでカメラロールへ遷移する |
| **詳細** | ボトムツールバー（F3.4）の左側に、直近に撮影した写真のサムネイルを表示する。タップするとシステムの写真アプリ（カメラロール）へ遷移する。撮影前（サムネイルなし）は空の枠を表示する。新しい撮影後はサムネイルがフェードインで切り替わる。 |
| **受け入れ条件** | - 撮影後、直近の写真サムネイルが表示される<br>- サムネイルタップでカメラロールに遷移する<br>- 撮影前は空の枠が表示される<br>- 新しい写真撮影時にサムネイルが更新される |
| **技術アプローチ** | PHPhotoLibrary最新写真取得 → サムネイルImage表示 → URL Schemeでカメラロール起動 |
| **関連ファイル** | `Services/PhotoLibraryService.swift`, `Views/Components/Skeuomorphic/BottomToolbar.swift` |

---

## F4. シャッター演出

撮影時の演出効果。iOS 4〜6時代のカメラアプリの撮影体験を再現する。

### F4.1 虹彩絞り（アイリス）アニメーション

| 項目 | 内容 |
|------|------|
| **機能ID** | F4.1 |
| **概要** | 撮影時に虹彩絞りが閉じる→開くアニメーションを表示する |
| **詳細** | シャッターボタンタップ時に、カメラプレビュー上で虹彩絞り（アイリス）のアニメーションを再生する。6〜8枚の絞り羽根が中心に向かって閉じ、完全に閉じた後に再度開く。このアニメーション中に実際の撮影処理（F1.2）を実行する。 |
| **受け入れ条件** | - 撮影時に虹彩絞りアニメーションが表示される<br>- 絞り羽根が自然に閉じる→開く動きをする<br>- アニメーション時間が適切（閉じる: 約0.2秒、開く: 約0.3秒）<br>- iOS 4〜6時代の虹彩絞りアニメーションの雰囲気を再現している |
| **技術アプローチ** | SwiftUI: カスタムShape（多角形の絞り羽根）+ withAnimation でスケール/回転 |
| **関連ファイル** | `Views/Components/Skeuomorphic/IrisShutter.swift` |

### F4.2 シャッター音

| 項目 | 内容 |
|------|------|
| **機能ID** | F4.2 |
| **概要** | 撮影時にiPhone 4風のシャッター音を再生する |
| **詳細** | 撮影時にiPhone 4のカメラシャッター音に近いSEを再生する。システムのシャッター音ではなく、カスタムSEを使用する。**消音モードに関係なく常にシャッター音を鳴らす**（日本市場向け要件）。 |
| **受け入れ条件** | - 撮影時にシャッター音が再生される<br>- iPhone 4のシャッター音に近い音色である<br>- 消音モードでもシャッター音が鳴る<br>- 音量が適切である（大きすぎず小さすぎず） |
| **技術アプローチ** | AudioServicesPlaySystemSound（SystemSoundID）で消音モードを無視して再生。またはAVAudioSession.categoryを.playbackに設定 |
| **関連ファイル** | `Resources/Sounds/`, `Services/CameraService.swift` |
| **注意事項** | シャッター音のSEファイルは著作権に配慮し、オリジナルまたはフリー素材を使用する |

### F4.3 白フェード演出

| 項目 | 内容 |
|------|------|
| **機能ID** | F4.3 |
| **概要** | 撮影直後にフラッシュ的な白フェード演出を表示する |
| **詳細** | 撮影直後に画面全体が一瞬白くフラッシュし、フェードアウトする演出。虹彩絞りアニメーション（F4.1）と連携し、絞りが閉じた直後〜開く直前に白フェードを挿入する。 |
| **受け入れ条件** | - 撮影直後に白フェード演出が表示される<br>- フェードの時間が適切（約0.1〜0.2秒）<br>- 虹彩絞りアニメーションと自然に連携する |
| **技術アプローチ** | SwiftUI: Color.white オーバーレイ + opacity アニメーション |
| **関連ファイル** | `Views/Screens/CameraScreen.swift` |

---

## F5. パーミッション管理

カメラ・フォトライブラリへのアクセス許可に関する機能。

### F5.1 カメラ・フォトライブラリのアクセス許可

| 項目 | 内容 |
|------|------|
| **機能ID** | F5.1 |
| **概要** | カメラとフォトライブラリへのアクセス許可を管理する |
| **詳細** | アプリ初回起動時にカメラとフォトライブラリへのアクセス許可を要求する。ユーザーが許可を拒否した場合、シンプルなアラートで「設定アプリから許可してください」と案内し、設定アプリへのリンクボタンを表示する。 |
| **受け入れ条件** | - 初回起動時にカメラのアクセス許可ダイアログが表示される<br>- 撮影時にフォトライブラリのアクセス許可ダイアログが表示される（未許可の場合）<br>- 許可が拒否されている場合、アラートで設定アプリへの誘導が表示される<br>- 設定アプリへのリンクボタンをタップすると設定アプリが開く<br>- 許可状態が変わった場合（設定アプリで変更後、アプリに戻った時）に適切に反映される |
| **技術アプローチ** | AVCaptureDevice.requestAccess(for:) + PHPhotoLibrary.requestAuthorization() + UIApplication.shared.open(URL(string: UIApplication.openSettingsURLString)!) |
| **関連ファイル** | `Services/CameraService.swift`, `Services/PhotoLibraryService.swift`, `ViewModels/CameraViewModel.swift` |

---

## 機能間の依存関係

```
F1.1 リアルタイムプレビュー ← F2.1 暖色系色味
                             ← F2.2 画角クロップ

F1.2 写真撮影・保存 ← F2.1 暖色系色味
                     ← F2.2 画角クロップ
                     ← F2.3 手ブレシミュレーション
                     ← F4.1 虹彩絞りアニメーション
                     ← F4.2 シャッター音
                     ← F4.3 白フェード演出

F1.3 フラッシュ切り替え ← F5.1 パーミッション管理（カメラ許可が前提）
F1.4 カメラ切り替え     ← F5.1 パーミッション管理（カメラ許可が前提）

F3.1 トップツールバー ← F1.3 フラッシュ切り替え
                      ← F1.4 カメラ切り替え

F3.4 ボトムツールバー ← F3.3 シャッターボタン
                      ← F3.5 直近撮影写真サムネイル
```

---

## 実装優先順位

MVP要件書のリスク対策「1週間で間に合わない場合、手ブレシミュレーションをPhase 2に回す」に基づき、以下の優先順位で実装する。

### Priority 1（必須 — これがないとアプリとして成立しない）

| 順序 | 機能ID | 機能名 | 理由 |
|------|--------|--------|------|
| 1 | F5.1 | パーミッション管理 | カメラ・フォトライブラリへのアクセスが全機能の前提 |
| 2 | F1.1 | リアルタイムカメラプレビュー | カメラアプリの基盤 |
| 3 | F1.2 | 写真撮影・保存 | コア機能 |
| 4 | F2.1 | 暖色系の色味 | iPhone 4再現の最重要要素（最優先フィルター） |
| 5 | F2.2 | 画角クロップ | iPhone 4の画角再現 |

### Priority 2（MVP完成に必要）

| 順序 | 機能ID | 機能名 | 理由 |
|------|--------|--------|------|
| 6 | F3.3 | シャッターボタン | 撮影UIの中核 |
| 7 | F3.1 | トップツールバー | 操作UIの基盤 |
| 8 | F3.4 | ボトムツールバー | 画面レイアウトの基盤 |
| 9 | F3.2 | ファインダー | プレビュー表示エリア |
| 10 | F1.3 | フラッシュ切り替え | カメラ基本機能 |
| 11 | F1.4 | カメラ切り替え | カメラ基本機能 |

### Priority 3（MVP品質向上）

| 順序 | 機能ID | 機能名 | 理由 |
|------|--------|--------|------|
| 12 | F4.1 | 虹彩絞りアニメーション | レトロ体験の演出 |
| 13 | F4.2 | シャッター音 | レトロ体験の演出 |
| 14 | F4.3 | 白フェード演出 | レトロ体験の演出 |
| 15 | F3.5 | 直近撮影写真サムネイル | 利便性 |
| 16 | F2.3 | 手ブレシミュレーション | スケジュールリスク時にPhase 2へ回す候補 |

---

## MVPに含めない機能（対象外）

以下の機能はMVP（Phase 1）の対象外とする。

- 動画撮影
- 写真編集・フィルター強度調整
- SNS共有機能（OSのシェアシートで対応）
- 複数機種の切り替え（iPhone 5s、6s等）
- アカウント登録・ログイン
- アプリ内課金
- 撮影した写真のギャラリー表示（カメラロールで対応）
- ランドスケープ（横持ち）対応
- 低解像度による柔らかいぼんやり感（Phase 2）
- デジタルノイズ/粒状感（Phase 2）
- 強いコントラストと自然な白飛び・影（Phase 2）
